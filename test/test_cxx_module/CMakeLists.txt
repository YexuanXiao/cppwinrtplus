cmake_minimum_required(VERSION 4.3)
project(winrt_module_test LANGUAGES CXX)

set(CMAKE_CXX_MODULE_STD 1)
set(CMAKE_CXX_STANDARD 23)
set(CMAKE_CXX_EXTENSIONS OFF)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

set(CPPWINRT_EXE "cppwinrt" CACHE FILEPATH "Path to cppwinrt executable")
set(CPPWINRT_OUT_DIR "${CMAKE_CURRENT_BINARY_DIR}/cppwinrt")

execute_process(
    COMMAND "${CPPWINRT_EXE}" -input local -output "${CPPWINRT_OUT_DIR}" -modules -verbose
    RESULT_VARIABLE CPPWINRT_RESULT
)
if(NOT CPPWINRT_RESULT EQUAL 0)
    message(FATAL_ERROR "cppwinrt failed with exit code ${CPPWINRT_RESULT}")
endif()

file(GLOB CPPWINRT_MODULES
    LIST_DIRECTORIES false
    CONFIGURE_DEPENDS
    "${CPPWINRT_OUT_DIR}/winrt/*.ixx"
)
list(SORT CPPWINRT_MODULES)

# Generate a TU that imports every generated module so the test exercises the import surface
# (excluding `winrt.base`, which is expected to be reachable via re-export from other modules).
set(IMPORT_ALL_CPP "${CMAKE_CURRENT_BINARY_DIR}/import_all.cpp")
set(IMPORT_ALL_CONTENT "// Generated by CMake: imports all C++/WinRT namespace modules for verification.\n\n")
foreach(module_path IN LISTS CPPWINRT_MODULES)
    # `NAME_WE` strips the *longest* extension (e.g. "Windows.Foundation.ixx" -> "Windows"),
    # so remove only the trailing ".ixx" explicitly.
    get_filename_component(module_file "${module_path}" NAME)
    string(REGEX REPLACE "\\.ixx$" "" module_name "${module_file}")
    if(module_name STREQUAL "winrt.base")
        continue()
    endif()
    string(APPEND IMPORT_ALL_CONTENT "import ${module_name};\n")
endforeach()
string(APPEND IMPORT_ALL_CONTENT "\nint winrt_import_all_dummy = 0;\n")
file(WRITE "${IMPORT_ALL_CPP}" "${IMPORT_ALL_CONTENT}")

add_executable(main main.cpp "${IMPORT_ALL_CPP}")
target_sources(main
    PRIVATE
        FILE_SET cxx_modules TYPE CXX_MODULES BASE_DIRS "${CPPWINRT_OUT_DIR}/winrt" FILES ${CPPWINRT_MODULES}
)
target_include_directories(main PRIVATE "${CPPWINRT_OUT_DIR}")
target_link_libraries(main PRIVATE runtimeobject synchronization)

enable_testing()
add_test(NAME main COMMAND main)
